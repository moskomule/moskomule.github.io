<!DOCTYPE HTML>

<html>

<head>
    <title>
        研究のためのDocker入門 | moskomule log
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/css/highlight_monokai.css" />
    <link rel="stylesheet" href="/css/material-components-web.css" />
    <link rel="stylesheet" href="/css/custom.css" />

    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha256-tkzDFSl16wERzhCWg0ge2tON2+D6Qe9iEaJqM4ZGd4E=" crossorigin="anonymous" type="text/css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha256-gNVpJCw01Tg4rruvtWJp9vS0rRchXP2YF+U+b2lp8Po=" crossorigin="anonymous" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha256-ExtbCSBuYA7kq1Pz362ibde9nnsHYPt6JxuxYeZbU+c=" crossorigin="anonymous" type="text/javascript"></script>
</head>

<body>
    <div class="top">
        
        <div class="mdc-toolbar mdc-toolbar--fixed mdc-toolbar--waterfall mdc-toolbar--flexible mdc-toolbar--flexible-default-behavior mdc-toolbar--flexible-space-maximized">
            <div class="mdc-toolbar__row">
                <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
                    <button class="header-menu material-icons mdc-toolbar__icon--menu">menu</button>
                    <span class="mdc-toolbar__title">研究のためのDocker入門 | moskomule log</span>
                </section>
                <section class="mdc-toolbar__section mdc-toolbar__section--align-end" role="toolbar">
                    
                </section>
            </div>
        </div>

        
        <aside class="mdc-temporary-drawer">
            <nav class="mdc-temporary-drawer__drawer">
                <header class="mdc-temporary-drawer__header">
                    <div class="mdc-temporary-drawer__header-content mdc-theme--primary-bg mdc-theme--text-primary-on-primary">
                        <div id="introduction">
                            <a href="https://mosko.tokyo/" class="mdc-list">
                                moskomule log
                            </a>
                        </div>
                    </div>
                </header>
                <nav class="mdc-temporary-drawer__content mdc-list-group">
                    <div id="icon-with-text" class="mdc-list">
                        <a class="mdc-list-item" href="/#about">
                            <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">star</i>About
                        </a>
                        <a class="mdc-list-item" href="/#articles">
                            <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">book</i>Articles
                        </a>
                    </div>
                    <hr class="mdc-list-divider">
                    <div class="mdc-list">
                        <a class="mdc-list-item" href="/#contact">
                            <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">send</i>Contact
                        </a>
                    </div>
                    <hr class="mdc-list-divider" />
                    
                    <div class="mdc-list social">
                        <a class="mdc-list-item" href="https://twitter.com/mosko_mule">
                            <i class="fa fa-2x fa-twitter" aria-hidden="true"></i> twitter
                        </a>
                    </div>
                    
                    <div class="mdc-list social">
                        <a class="mdc-list-item" href="https://github.com/moskomule">
                            <i class="fa fa-2x fa-github" aria-hidden="true"></i> github
                        </a>
                    </div>
                    

                    
                    
                    
                    <hr class="mdc-list-divider">
                    
                    
                    <div class="languages">
                        <a class="mdc-list-item selected_lang" href="https://mosko.tokyo/ja">
                            <i class="material-icons mdc-list-item__start-detail">language</i> <span>日本語</span>
                        </a>
                    </div>
                    
                    
                    <div class="languages">
                        <a class="mdc-list-item " href="https://mosko.tokyo/en">
                            <i class="material-icons mdc-list-item__start-detail">language</i> <span>English</span>
                        </a>
                    </div>
                    
                    

                </nav>
            </nav>
        </aside>
    </div>
    <main>
        <div class="mdc-toolbar-fixed-adjust"></div>



<div id="main">
    <div class="container">
        <div class="article-header">
            <h1>研究のためのDocker入門</h1>
            <div class="meta-data">
                Oct 19, 2017 &nbsp;  <span class="article-tag"><a href="/tags/docker">#docker</a></span>&nbsp;  <span class="article-tag"><a href="/tags/">#</a></span>&nbsp; 
            </div>
        </div>
        <aside>
            <nav id="TableOfContents">
<ul>
<li><a href="#はじめに">はじめに</a></li>
<li><a href="#インストール等">インストール等</a></li>
<li><a href="#イメージを作る">イメージを作る</a>
<ul>
<li><a href="#dockerfileの解説">Dockerfileの解説</a></li>
<li><a href="#ビルド">ビルド</a></li>
<li><a href="#コンテナの起動">コンテナの起動</a></li>
</ul></li>
<li><a href="#nvidia-docker">nvidia-docker</a></li>
<li><a href="#その他">その他</a></li>
</ul>
</nav>
        </aside>
        <article>

            

<h1 id="はじめに">はじめに</h1>

<p>「TensorFlowのCustomOpsが古いGCCでしかコンパイルできず詰んだ」「先輩から引き継いだコードを動かす環境構築が面倒」といった経験はないでしょうか．この記事ではDockerを使うことで環境依存/環境汚染の問題を減らすことを考えていきます．</p>

<p>1年ほど前からDockerの存在は知っていましたが，いざはじめようと「Docker入門」のような記事を読むとUbuntuのイメージをプルしてコンテナを作ってお疲れ様でした，という感じであまり御利益が分かりませんでした．</p>

<p>先日<a href="https://liginc.co.jp/363659">絶対に挫折しない！オープンソースソフトウェア「Docker」入門編 #04</a>という記事でDockerfileを作って環境を構築する話を読んで少し得心できました．どこでも同一のコマンドで同一の環境を，ホストの環境を汚さずに作れるので非常に便利です．</p>

<h1 id="インストール等">インストール等</h1>

<p><a href="https://www.docker.com/community-edition#/download">DockerCE</a>をダウンロードしてインストールします．環境によっては<a href="https://www.docker.com/products/docker-toolbox">Docker toolbox</a>を利用する必要があります．</p>

<p>Linuxの場合は<a href="https://docs.docker.com/engine/installation/linux/linux-postinstall/#configure-docker-to-start-on-boot">インストール後</a>に</p>

<pre><code>$ sudo groupadd docker
$ sudo usermod -aG docker $USER
$ logout # login later
</code></pre>

<p>を行います．インストールが成功していれば以下のようになるはずです．</p>

<pre><code>$ docker run --rm hello-world
...
Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.
</code></pre>

<p>DockerではDockerfileに従って（Ubuntuのブートディスクのような）Dockerイメージを作ります．このイメージにはOSやアプリケーションなどが入っています．このイメージを起動して実体となったものがコンテナです．コンテナは複数起動したり，ホスト・他のコンテナとやりとりしたりすることができます．起動のコストが大きくないので必要に応じて使い捨てることもできます．</p>


<figure >
    
        <img src="https://www.docker.com/sites/default/files/Package%20software.png" />
    
    
    <figcaption>
        <h4>https://www.docker.com/what-container より</h4>
        
    </figcaption>
    
</figure>


<h1 id="イメージを作る">イメージを作る</h1>

<p>DockerのイメージはDockerfileからビルドするほかに<a href="https://hub.docker.com/explore/">DockerHub</a>などから入手することも出来ます．先ほどの</p>

<pre><code>$ docker run --rm hello-world
</code></pre>

<p>ではローカルに<code>hello-world</code>イメージがないのでDockerHubからプルしてきています．Dockerのイメージは層状になっていて既存のものにファイルを加えたり環境変数を書き換えたりして自分の必要なものにしていきます．</p>

<p>それでは実際にDockerfileを書いてJupyterのイメージを作ってみましょう．空のディレクトリに<code>Dockerfile</code>と<code>requirements.txt</code>を作ります．</p>

<pre><code># Dockerfile
FROM ubuntu:latest
RUN apt-get update \
    &amp;&amp; apt-get install -y wget bzip2 \
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*
WORKDIR /opt
RUN wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh \
    &amp;&amp; bash miniconda.sh -b -p /opt/.miniconda \
    &amp;&amp; rm miniconda.sh
ENV PATH /opt/.miniconda/bin:$PATH
COPY requirements.txt /opt
RUN pip install --no-cache-dir -r requirements.txt &amp;&amp; rm requirements.txt
</code></pre>

<pre><code># requirements.txt
jupyter
</code></pre>

<h2 id="dockerfileの解説">Dockerfileの解説</h2>

<ul>
<li><code>FROM ubuntu:latest</code>はubuntuの最新のものをベースとすることを示します．</li>
<li><code>RUN</code>によってコマンドを実行できます．

<ul>
<li>各<code>RUN</code>は独立なので注意が必要です．例えば<code>RUN cd foo</code>を行っても次の<code>RUN pwd</code>は<code>foo</code>ではありません．</li>
<li>イメージにはキャッシュも保存されてしまうので，たとえば<code>apt-get</code>ならば<code>apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*</code>でキャッシュをなくすことが望ましいです．</li>
<li>各行毎に中間イメージが作られて差分を重ねていき，他のイメージのビルドジにも再利用されます．このことを意識してコマンドをまとめましょう．</li>
</ul></li>
<li><code>WORKDIR</code>によって作業ディレクトリに移動します．<code>RUN cd foo</code>と異なり移動は引き継がれます．</li>
<li><code>ENV</code>によって環境変数を設定できます．</li>
<li><code>COPY from_path to_path</code>によってDockerfileのあるディレクトリ以下にあるファイルを取り込むことが出来ます．</li>
</ul>

<p>その他詳しくは<a href="http://docs.docker.jp/engine/reference/builder.html">Dockerfileリファレンス</a>や<a href="http://docs.docker.jp/engine/reference/builder.html">Dockerfileベストプラクティス</a>をご覧下さい．</p>

<h2 id="ビルド">ビルド</h2>

<pre><code>$ docker build -t foo_name .
</code></pre>

<p>を実行すると<code>foo_name:latest</code>イメージがビルドされます．<code>-t foo_name</code>は随意ですが，（上の例なら<code>my-jupyter</code>のような）名前を与えた方が便利です．作成したイメージは<code>docker images</code>で確認できます．</p>

<pre><code>$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
jupyter             latest              052c2b285aea        4 days ago          925MB
</code></pre>

<h2 id="コンテナの起動">コンテナの起動</h2>

<p>コンテナは<code>docker run NAME COMMAND</code>によって起動できます．</p>

<pre><code>$ docker -it --rm jupyter bash
root@45891a31b86d:/opt#
root@45891a31b86d:/opt# pwd
/opt
root@45891a31b86d:/opt# exit
</code></pre>

<ul>
<li>つまり<code>docker run [options] IMAGE_NAME COMMAND</code>です．</li>
<li><code>-it</code>によってインタラクティブに扱うことができます．<code>-i</code>は<code>--interactive</code>，<code>-t</code>は<code>--tty</code>と同一です．</li>
<li><code>--rm</code>を指定することで終了後に自動でコンテナが消去されます．</li>
</ul>

<p>実際にjupyter notebookを使うには以下のようにします．</p>

<pre><code>docker run --rm \
    -p 8888:8888 \
    -v host/path:container/path \
    jupyter jupyter notebook --ip=0.0.0.0 --allow-root --no-browser
</code></pre>

<ul>
<li><code>-p 8888:8888</code>によってコンテナ側の<code>8888</code>ポートがホスト側の<code>localhost:8888</code>となります．</li>
<li><code>-v host/path:/container/path</code>によってホストとコンテナとでディレクトリを共有することが出来ます．この場合ホスト側の<code>host/path</code>がコンテナは<code>/container/path</code>からアクセスできます．</li>
</ul>

<p>shellスクリプトからコンテナを起動することで諸々のインストールの手続きを簡略化することなどもできると思います．</p>

<pre><code>#!/bin/bash
# docker-mecab
docker run -it --rm mymecab mecab $@
</code></pre>

<h1 id="nvidia-docker">nvidia-docker</h1>

<p>DockerでGPUを使うときにはドライバの指定が必要でいささか面倒です．これを解決するのが<a href="https://github.com/NVIDIA/nvidia-docker">nvidia-docker</a>です．nvidia-dockerを用いることで一台のマシンで複数のcudaを使ったり，コンテナ毎に使用するGPUを分離したりすることができます．</p>

<p>基本的には上記のリンクに従えばインストールし，使用できると思いますが自分の環境(Ubuntu 16.04)ではインストール後に</p>

<pre><code>$ nvidia-docker run --rm nvidia/cuda nvidia-smi
Error: Could not load UVM kernel module. Is nvidia-modprobe installed?
</code></pre>

<p>となったので，以下を行いました．</p>

<pre><code>$ sudo apt-add-repository multiverse
$ sudo apt-get update
$ sudo apt-get install nvidia-modprobe
</code></pre>

<p>nvidia-dockerはラッパーなので，GPUを使う場合には<code>nvidia-docker run ...</code>とするだけでそれ以外の差異はありません．</p>

<h1 id="その他">その他</h1>

<ul>
<li>不要なイメージは<code>docker rmi IMAGE_NAME</code>で削除します．不要なイメージを全て消す場合は<code>docker rmi $(docker images -f &quot;dangling=true&quot; -q)</code>とします．</li>
<li>不要なコンテナは<code>docker rm CONTAINER_NAME</code>で削除します．使われていないコンテナを全て消す場合は<code>docker rm $(docker ps -aq)</code>で削除します．</li>
<li>ホストがCentOSのときに不具合が多い経験があります．<a href="http://postd.cc/docker-in-production-an-update/">Dockerに依存しすぎるのは危険です</a>．</li>
</ul>


            
            
        </article>
        <nav class="pagination-single">
            
            <span class="previous">&larr; <a href="https://mosko.tokyo/notes/info_ml2/" rel="prev">情報論的学習理論2</a></span>  
        </nav>

        <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "moskomule-log" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>

</div>


<footer class="copyright">

    
    <span class="copyright">
                <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>&nbspWritten by Ryuichiro Hataya, Powered by <a href="https://gohugo.io/">Hugo</a>
    </span>

</footer>
</main>




<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script type="text/javascript">
    hljs.initHighlightingOnLoad();
</script>


<script type="text/javascript" src="/js/material-components-web.js"></script>
<script type="text/javascript">
    var drawerEl = document.querySelector('.mdc-temporary-drawer');
    var MDCTemporaryDrawer = mdc.drawer.MDCTemporaryDrawer;
    var drawer = new MDCTemporaryDrawer(drawerEl);
    document.querySelector('.header-menu').addEventListener('click', function() {
        drawer.open = true;
    });
    drawerEl.addEventListener('MDCTemporaryDrawer:open', function() {
        console.log('Received MDCTemporaryDrawer:open');
    });
    drawerEl.addEventListener('MDCTemporaryDrawer:close', function() {
        console.log('Received MDCTemporaryDrawer:close');
    });
</script>

<script type="text/javascript">
    (function() {
        var pollId = 0;
        pollId = setInterval(function() {
            var pos = getComputedStyle(document.querySelector('.mdc-toolbar')).position;
            if (pos === 'fixed' || pos === 'relative') {
                init();
                clearInterval(pollId);
            }
        }, 250);

        function init() {
            var toolbar = mdc.toolbar.MDCToolbar.attachTo(document.querySelector('.mdc-toolbar'));
            toolbar.listen('MDCToolbar:change', function(evt) {
                var flexibleExpansionRatio = evt.detail.flexibleExpansionRatio;
                ratioSpan.innerHTML = flexibleExpansionRatio.toFixed(2);
            });
            toolbar.fixedAdjustElement = document.querySelector('.mdc-toolbar-fixed-adjust');
        }
    })();
</script>


<script>
    renderMathInElement(
        document.body, {
            delimiters: [{
                    left: "$$",
                    right: "$$",
                    display: false
                },
                {
                    left: "\\[",
                    right: "\\]",
                    display: true
                },
                {
                    left: "$",
                    right: "$",
                    display: false
                }
            ],
            ignoredTags: [
                "script",
                "noscript",
                "style",
                "textarea",
                "pre",
                "code"
            ]
        }
    );
</script>
</body>

</html>

