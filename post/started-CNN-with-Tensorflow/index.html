
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    TensorflowでCNN入門 | moskomule log
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://mosko.tokyo/post/started-CNN-with-Tensorflow/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="http://mosko.tokyo/index.xml" rel="alternate" type="application/rss+xml" title="moskomule log" />
  <link href="http://mosko.tokyo/index.xml" rel="feed" type="application/rss+xml" title="moskomule log" />

  
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://mosko.tokyo/">moskomule log</a></h1>
        <h2>carpe diem</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/mosko_mule" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/moskomule" target="_blank">GitHub</a></li>
          <li><a href="http://mosko.tokyo/index.xml" type="application/rss+xml" target="_blank">RSS</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>TensorflowでCNN入門</h1>
      <div class="meta">
        Oct 19, 2016 &nbsp;
        
          #<a href="/tags/python">Python</a>&nbsp;
        
          #<a href="/tags/deep-learning">Deep Learning</a>&nbsp;
        
          #<a href="/tags/jupyter">Jupyter</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<p>いよいよDeep Learningからは逃れられない運命，真剣に向かい合わざるを得ないことを悟り，<a href="https://github.com/alrojo/tensorflow-tutorial">TensorFlow Tutorial-used by Nvidia</a>を始めた．</p>

<p>前半は実は正しくなくて，今までも何度か<a href="https://www.tensorflow.org/versions/r0.11/tutorials/index.html">TensorflowのTutorial</a>を触ったものの，また，TensorFlowやChainerを使ったものの，まったく理解できないまま終わってしまっていた．</p>

<p>今回は偶然にも前述のTutorialと出逢うことが出来たので試してみた．</p>

<h2 id="環境構築">環境構築</h2>

<p>細かいことは考えずに<a href="https://www.continuum.io/downloads">Anaconda</a>を入れてしまうのが早い．基本的なパッケージは揃っているし，IntelのMKLが使えるNumpyなども特に設定せずに導入できる．導入後，</p>

<pre><code class="language-shell">
conda update --all

conda install tensorflow

</code></pre>

<p>を行えば終了．ではあるが，GPUを使いたい場合は<a href="https://www.tensorflow.org/versions/master/get_started/os_setup.html#pip-installation">公式</a>にしたがって<code>pip</code>を叩く必要がある．なお，このTutorialはPython2向けに書かれているので，すでにAnaconda py35を入れてしまっている場合には</p>

<pre><code class="language-shell">
conda create -n py27 python=2.7 anaconda

source activate py27

</code></pre>

<p>が必要となる．<code>pyenv</code>を使うと環境への影響が少ないのだけれど，自分の環境ではAnacondaのIntel Math Kernel Libraryが上手く動かないようなので使っていない．</p>

<h2 id="tutorial">Tutorial</h2>

<p><a href="https://github.com/alrojo/tensorflow-tutorial/blob/master/lab2_CNN/lab2_CNN.ipynb">Tutorial Lab2</a>．Jupyter Notebookの偉大さが分かる．</p>

<p>構成もよく出来ていて，MNISTをMulti-Layer Parceptronで解く，Convolutional層を追加する，Pooling層を追加する，重ねてみる，Dropoutも追加してみる，というような流れなのでそれぞれの層の意味がよく理解できるし，<a href="http://amzn.to/2el8pLx">岡谷先生の本</a>ではそうかそうか，と式だけ追っていたようなことが目に見える形で現れるのは純粋に楽しいので捗るし，理解が深まる．</p>

<p>MNISTなので上手くいって当然なのだろうけれど，試行錯誤していくと正答率があがって過学習が減っていくのは面白い．</p>

<p>{% asset_img mnist.png 最終結果 %}</p>

<h2 id="チャネル数">チャネル数</h2>

<p>途中で，<code>channels</code>，チャネル数がよく分からなかったのだけれども，岡谷先生の本が参考になった．入力がRGB画像の場合は入力層の場合はチャンネル数はRGBの3である．ここで，チャンネル数 $K$ ,大きさ $W\times W$ であるものを $W\times W\times K$ と表すこととする．</p>

<p>いま，Convolutional層の入力のサイズを$W\times W\times K$，$m$種類のフィルターのサイズを$H\times H\times K$とすると，</p>

<p>$$</p>

<p>u_{ijm}=\sum_{k=0}^{K-1}\sum_{p=0}^{H-1}\sum_{q=0}^{H-1}z_{i+p,j+q,k}^{(l-1)}h_{pqkm}+b_{ijm}</p>

<p>$$</p>

<p>畳み込み層の出力としてはこれに活性化函数を適用した $z_{ijm}=f(u_{ijm})$  が得られる．したがって，$W\times W\times K$であった入力は，出力時には$W\times W\times M$となっている．この$M$が次の層ではチャネル数となる．ということのようだ．</p>

<hr />

<h2 id="備忘録-sqlの最適化">備忘録:SQLの最適化</h2>

<p>いま携わっているプロジェクトではSQLのクエリを投げ続けるので速度が重要なのだが，いじっているうちに1件の応答に数秒かかるほど遅くなってしまった．このときの解決手順．今までDBで大きなデータを取り扱うことはなかっただけに，DBの応答が遅いのは予想外で気付くのに時間を要した．</p>

<pre><code class="language-sql">
OPTIMIZE TABLE TABLE_NAME;

ALTER TABLE TABLE_NAME ADD INDEX(id, name);

</code></pre>

<p>後者のインデックスの張り直しが重要そう．</p>

      
      
      
    </article>
    


  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="http://mosko.tokyo/post/italy-misc/" rel="prev">イタリア旅行記補遺(1)</a></span>
    
    
      <span class="next"><a href="http://mosko.tokyo/post/python-and-mysql/" rel="next">PythonでMySQLを使う</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      
      Written by Ryuichiro Hataya
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

